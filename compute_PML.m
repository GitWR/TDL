function [T , det_log] = compute_PML(data_train,Train_labels,d_value)

%This part is for Projection Metric Learning
  
  itera=4;%优化时的迭代次数
  num_class=length(unique(Train_labels));%类别数
%给投影矩阵赋初值，按照论文里面的给法，给一个单位矩阵,也可以给一个随机数组成的矩阵，具体得看实验结果情况
  D=size(data_train{1},1); % D=400
%   T0=eye(D,d_value);%按照论文中的给法，给一个单位阵
%   T=T0;
  T =rand(D,d_value);%投影矩阵初始值为一个随机矩阵，也可以是单位矩阵，但是在本代码中用单位矩阵会出现奇异值
  %det_log=zeros(1,itera);%用于存储后面的判别收敛条件时候得到的值
  count=0; % 用于统计不满足条件的次数，往往一次不满足的话就退出，可能会有偶然性
  count1=0;
  num_eachset=size(data_train{1},2);%每个图像集中的样本数
  PCA_data=cell(1,length(data_train));%用于存放投影后的数据
  
% for pca_i=1:length(data_train)
%   PM(:,(pca_i-1)*num_eachset+1:pca_i*num_eachset)=data_train{pca_i};%所有样本从左到右存到PM矩阵中    
% end
% 
%   [pca_v,pca_e]=eig(PM*PM');%特征分解
%   pca_e_unsort=diag(pca_e);%未排序的特征值列向量
%   [pca_e_sort,index]=sort(pca_e_unsort,'descend');%降序排列
%   pca_v_sort=fliplr(pca_v);%按照特征值的顺序调整特征向量
%   pca_W=pca_v_sort(:,1:d_value);%400*60
%   
% for i=1:length(data_train)
%   PCA_data{i}=pca_W'*data_train{i};%对数据进行降维，60*40也即d*q
% end

for i=1:itera
  t_start=cputime;
  fprintf('\n i= %d \n',i);
  Y_change=Normalized(data_train,T);%用Y'代替Y，保证W’*Y_change的正定性，也即对Y的规范化处理
  Sw=zeros(D,D);
  Sb=zeros(D,D);
  Nw=0;
  Nb=0;
  for j=1 : num_class
      num_eachclass=find(Train_labels==j);%统计出每一类的样本的索引
      for k=1 : length(num_eachclass)
          Y_change1=Y_change{num_eachclass(k)};
          for m=k+1 : length(num_eachclass)
              Y_change2=Y_change{num_eachclass(m)};
              Y_mapping1=Y_change1*Y_change1';
              Y_mapping1=Y_mapping1+trace(Y_mapping1)*(1e-4)*eye(D);
              Y_mapping2=Y_change2*Y_change2';
              Y_mapping2=Y_mapping2+trace(Y_mapping2)*(1e-4)*eye(D);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
              temp=real(log(Y_mapping1))-real(log(Y_mapping2)); %论文中的公式（3）中的Aij
              Sw_temp=temp*T*T'*temp;
              Sw=Sw+Sw_temp;
              Nw=Nw+1;%用于统计成对的计算样本的个数
          end
      end
  end
  
  for j=1:num_class
      num_eachclass=find(Train_labels==j);%统计出每一类的样本的索引
      num_difclass=find(Train_labels~=j);%统计出和j不同类的样本索引
      for k=1:length(num_eachclass)
          Y_change1=Y_change{num_eachclass(k)};
          for m=1:length(num_difclass)
              Y_change2=Y_change{num_difclass(m)};
              Y_mapping1=Y_change1*Y_change1';
              Y_mapping1=Y_mapping1+trace(Y_mapping1)*(1e-4)*eye(D);
              Y_mapping2=Y_change2*Y_change2';
              Y_mapping2=Y_mapping2+trace(Y_mapping2)*(1e-4)*eye(D);
              temp=real(log(Y_mapping1))-real(log(Y_mapping2)); %论文中的公式（3）中的Aij
              Sb_temp=temp*T*T'*temp;
              Sb=Sb+Sb_temp;
              Nb=Nb+1;%用于统计成对的计算样本的个数
          end
      end
  end
  
  Sw_final=Sw/Nw;%论文中的公式（9）,400*400
  Sb_final=Sb/Nb;%论文中的公式（10）,400*400
%这里的迭代终止条件怎么给，我们希望投影后类内尽量靠的近，类间尽量散得开，因此每迭代一次，就分的越开。
  condition_con=inv(Sw_final)*Sb_final; %作为收敛条件
alpha=0.2;
Object_F=Sw_final-alpha*Sb_final;
Cost(i)=trace(T'*Object_F*T);
% if (i>1)
%     if (Cost(i)>=Cost(i-1))
%         count1=count1+1;
%         if (count1>=1)
%            break;
%         end
%     end
% end
fprintf(' iter\t            cost val\t \n    ');
fprintf('%5d\t \n%+.16e\t \n', i, Cost(:,1:i));
det_log(i)=log(det(condition_con));
% fprintf('收敛值为：%d \n',det_log(:,1:i)); 
%   if (i > 1)
%       if (det_log(i) < det_log(i-1))
%           count=count+1;
%           if (count>=3)
%                break;
%           end
%       end
%   end
%  t_start=cputime;
[Object_V , Object_E] = eig(Object_F);
E_unsort=diag(Object_E);
[E_sort , index]=sort(E_unsort,'Ascend');
V_sort=Object_V(:,index);%按照特征值的顺序，将特征向量升序排列
T=V_sort(:,1:d_value);
t_time=cputime-t_start;
t_time
clear cputime;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% %Riemannian Conjugate Gradient (RCG)
%   W=T*T';
% %   W=W+trace(W)*(1e-3)*eye(D);
%   alpha=0.3; %平衡系数
% %   spd = sympositivedefinitefactory(d_value);
%   spsd=symfixedrankYYfactory(D,rank(W));%问题出在这个函数中
%   problem.M = spsd;
%   problem.cost = @(P)  trace(P*Sw_final*P-alpha*P*Sb_final*P);%目标优化公式
%   problem.grad = @(P)  spsd.egrad2rgrad(P, 2*(Sw_final-alpha*Sb_final)*P);%目标函数的偏倒数
% %   problem.egrad = @(P)  2*(Sw_final-alpha*Sb_final)*P;%目标函数的偏倒数
%   options = [];    
%   options.maxiter = 100; %迭代次数
%   [P,cost,info] = conjugategradient(problem, W , options);
% %利用求得的W更新T，也即论文中的P更新w
%   [W_v , W_e]=eig(P);%目的是更新T
%   real_e=W_e(1:d_value,1:d_value);%取实部
%   real_v=W_v(:,1:d_value);%取实部
%   sqrt_e=sqrt(real_e);%把特征值矩阵开方分成两个同样的方阵
%   T=real_v*sqrt_e;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %T=P;
end
end


